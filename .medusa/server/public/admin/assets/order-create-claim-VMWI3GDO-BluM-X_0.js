import{I as ze}from"./chunk-QJ6SBVJ2-DYY1vmVy.js";import{R as It,C as St,O as Nt}from"./chunk-P3DRE4IY-DRXh-Upf.js";import{M as Ve}from"./chunk-NNBHHXXN-BZQRWjqU.js";import{c as Ct,d as Pt,e as Et,u as wt,f as qt,g as kt,h as At,i as Mt,j as Dt,k as Tt,l as Rt,m as Ot,n as Ht,o as Ft,p as Lt,q as Bt}from"./chunk-HQYV3NKX-Cu79ZScM.js";import{g as Ue,D as zt}from"./chunk-PXZ7QYKX-S5MjHeEM.js";import{c as Vt,o as Ut}from"./chunk-GUHHFSZA-CZzasLq6.js";import{D as Gt}from"./chunk-D4T3GFML-k03o88f9.js";import{a as J}from"./chunk-PDWBYQOW-BedvhUOI.js";import{P as Ge,a as $e}from"./chunk-IQBAUTU5-BRxZKND7.js";import{a2 as he,ad as qe,a4 as X,af as ke,a5 as $t,R as Qt,u as Xt,b as F,aS as Jt,aV as Wt,r as y,j as e,a8 as Kt,a9 as Zt,cS as Yt,y as Qe,t as T,H as ve,B as te,w as f,T as z,I as le,ab as en,cW as tn,aC as Xe,x as Ie,A as Je,X as Ae,s as We,cX as nn}from"./index-BuxV6e0B.js";import{u as Ke,_ as Ze}from"./chunk-B2JT2FOA-DJQBCjEL.js";import"./lodash-ButGdqO5.js";import{C as de}from"./chunk-2PMSBTXI-C44uOuaJ.js";import{c as oe}from"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-GJUPECDU-BESkt2FL.js";import{u as Ye}from"./chunk-C76H5USB-D-emvUqZ.js";import{K as sn}from"./chunk-6HTZNHPT-46xTxqsX.js";import{R as G,u as an,a as et,S as B}from"./chunk-4TC5YS65-D1UjD2uU.js";import{u as tt}from"./chunk-GRT22PE5-BZIxmkdo.js";import{u as on}from"./use-prompt-BYVko2sT.js";import{P as Me}from"./pencil-square-DrYvp8lc.js";import{X as nt}from"./x-circle-D_0PTroV.js";import{A as st}from"./alert-CvAq8Jjb.js";import{C as De}from"./currency-input-fSi5RInS.js";import{C as ce}from"./checkbox-DhpTDumb.js";import{c as it}from"./index-DwpPW5sH.js";import"./Trans-CF8gmQL9.js";import"./chunk-P3UUX2T6-Ch2QR5m0.js";import"./chunk-YEDAFXMB-CqqVMwDO.js";import"./chunk-AOFGTNG6-DlDZWCol.js";import"./table-Dco6R2DT.js";import"./chunk-EMIHDNB7-_mWCmww0.js";import"./plus-mini-mxvx0kJJ.js";import"./command-bar-BrgaOCRr.js";import"./index-D9jlmLrk.js";import"./x-mark-mini-DsfxIEYF.js";import"./triangles-mini-DtEEpPAa.js";import"./chunk-PFKKVLZX-WcuAW0zc.js";import"./format-7IPiT4y7.js";import"./_isIndex-CcRlYrDe.js";import"./date-picker-BgV4eukK.js";import"./popover-12uuNIe1.js";import"./triangle-left-mini-C0Rjyu6C.js";import"./index-BDd3Q1eQ.js";import"./prompt-BbGWPD2t.js";import"./index.esm-DK2vKniM.js";var ee=it(),rn=i=>{const{t:l}=F();return y.useMemo(()=>[ee.display({id:"select",header:({table:r})=>e.jsx(ce,{checked:r.getIsSomePageRowsSelected()?"indeterminate":r.getIsAllPageRowsSelected(),onCheckedChange:d=>r.toggleAllPageRowsSelected(!!d)}),cell:({row:r})=>{const d=r.getCanSelect();return e.jsx(ce,{disabled:!d,checked:r.getIsSelected(),onCheckedChange:s=>r.toggleSelected(!!s),onClick:s=>{s.stopPropagation()}})}}),ee.display({id:"product",header:()=>e.jsx(Ge,{}),cell:({row:r})=>e.jsx($e,{product:{thumbnail:r.original.thumbnail,title:r.original.product_title}})}),ee.accessor("variant.sku",{header:l("fields.sku"),cell:({getValue:r})=>r()||"-"}),ee.accessor("variant.title",{header:l("fields.variant")}),ee.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.quantity")})}),cell:({getValue:r,row:d})=>Ue(d.original)}),ee.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.price")})}),cell:({getValue:r})=>{const d=r()||0,s=J(d,i);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:s})})}})],[l,i])},ln=()=>{const{t:i}=F();return[{key:"returnable_quantity",label:i("orders.returns.returnableQuantityLabel"),type:"number"},{key:"refundable_amount",label:i("orders.returns.refundableAmountLabel"),type:"number"},{key:"created_at",label:i("fields.createdAt"),type:"date"},{key:"updated_at",label:i("fields.updatedAt"),type:"date"}]},dn=({pageSize:i=50,prefix:l})=>{const r=Ye(["q","offset","order","created_at","updated_at","returnable_quantity","refundable_amount"],l),{offset:d,created_at:s,updated_at:p,refundable_amount:m,returnable_quantity:v,...I}=r;return{searchParams:{...I,limit:i,offset:d?Number(d):0,created_at:s?JSON.parse(s):void 0,updated_at:p?JSON.parse(p):void 0,refundable_amount:m?JSON.parse(m):void 0,returnable_quantity:v?JSON.parse(v):void 0},raw:r}},xe=50,Te="rit",cn=({onSelectionChange:i,selectedItems:l,items:r,currencyCode:d})=>{const{t:s}=F(),[p,m]=y.useState(l.reduce((g,N)=>(g[N]=!0,g),{})),v=g=>{const N=typeof g=="function"?g(p):g;m(N),i(Object.keys(N))},{searchParams:I,raw:_}=dn({pageSize:xe,prefix:Te}),E=y.useMemo(()=>{const{order:g,offset:N,limit:H,q:w,created_at:W,updated_at:K,refundable_amount:Z,returnable_quantity:$}=I;let A=r;if(w&&(A=A.filter(L=>{var V;return L.product_title.toLowerCase().includes(w.toLowerCase())||L.variant_title.toLowerCase().includes(w.toLowerCase())||((V=L.variant_sku)==null?void 0:V.toLowerCase().includes(w.toLowerCase()))})),g){const L=g[0]==="-"?"desc":"asc",V=g.replace("-","");A=un(A,V,L)}return W&&(A=Re(A,W,"created_at")),K&&(A=Re(A,K,"updated_at")),$&&(A=He(A,$,"returnable_quantity",d)),Z&&(A=He(A,Z,"refundable_amount",d)),A.slice(N,N+H)},[r,d,I]),q=rn(d),k=ln(),{table:C}=Ke({data:E,columns:q,count:E.length,enablePagination:!0,getRowId:g=>g.id,pageSize:xe,enableRowSelection:g=>Ue(g.original)>0,rowSelection:{state:p,updater:v}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ze,{table:C,columns:q,pageSize:xe,count:E.length,filters:k,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:s("fields.product")},{key:"variant_title",label:s("fields.variant")},{key:"sku",label:s("fields.sku")},{key:"returnable_quantity",label:s("orders.fields.returnableQuantity")},{key:"refundable_amount",label:s("orders.fields.refundableAmount")}],prefix:Te,queryObject:_})})},un=(i,l,r)=>i.sort((d,s)=>{let p,m;return l==="product_title"?(p=d.product_title,m=s.product_title):l==="variant_title"?(p=d.variant_title,m=s.variant_title):l==="sku"?(p=d.variant_sku,m=s.variant_sku):l==="returnable_quantity"?(p=d.quantity-(d.returned_quantity||0),m=s.quantity-(s.returned_quantity||0)):l==="refundable_amount"&&(p=d.refundable||0,m=s.refundable||0),p<m?r==="asc"?-1:1:p>m?r==="asc"?1:-1:0}),Re=(i,l,r)=>{const{gt:d,gte:s,lt:p,lte:m}=l;return i.filter(v=>{const I=new Date(v[r]);let _=!0;return d&&(_=_&&I>new Date(d)),s&&(_=_&&I>=new Date(s)),p&&(_=_&&I<new Date(p)),m&&(_=_&&I<=new Date(m)),_})},Oe={eq:void 0,gt:void 0,gte:void 0,lt:void 0,lte:void 0},He=(i,l,r,d)=>{const{eq:s,gt:p,lt:m,gte:v,lte:I}=typeof l=="object"?{...Oe,...l}:{...Oe,eq:l};return i.filter(_=>{const E=_.quantity-(_.returned_quantity||0),q=J(_.refundable||0,d),k=r==="returnable_quantity"?E:q;if(s)return k===s;let C=!0;return p&&(C=C&&k>p),v&&(C=C&&k>=v),m&&(C=C&&k<m),I&&(C=C&&k<=I),C})};function mn({item:i,previewItem:l,currencyCode:r,form:d,onRemove:s,onUpdate:p,index:m}){const{t:v}=F(),{return_reasons:I=[]}=tn({fields:"+label"}),_=d.watch(`inbound_items.${m}`),E=typeof _.reason_id=="string",q=typeof _.note=="string";return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 border-b p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Xe,{src:i.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(z,{className:"txt-small",as:"span",weight:"plus",children:[i.title," "]}),i.variant_sku&&e.jsxs("span",{children:["(",i.variant_sku,")"]})]}),e.jsx(z,{as:"div",className:"text-ui-fg-subtle txt-small",children:i.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(f.Field,{control:d.control,name:`inbound_items.${m}.quantity`,render:({field:k})=>e.jsxs(f.Item,{children:[e.jsx(f.Control,{children:e.jsx(Ie,{...k,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:i.quantity,type:"number",onBlur:C=>{const g=C.target.value,N=g===""?null:Number(g);k.onChange(N),N&&p({quantity:N})}})}),e.jsx(f.ErrorMessage,{})]})}),e.jsx(z,{className:"txt-small text-ui-fg-subtle",children:v("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(Ve,{currencyCode:r,amount:l.return_requested_total})}),e.jsx(Je,{groups:[{actions:[!E&&{label:v("actions.addReason"),onClick:()=>d.setValue(`inbound_items.${m}.reason_id`,""),icon:e.jsx(St,{})},!q&&{label:v("actions.addNote"),onClick:()=>d.setValue(`inbound_items.${m}.note`,""),icon:e.jsx(zt,{})},{label:v("actions.remove"),onClick:s,icon:e.jsx(nt,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[E&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(f.Label,{children:v("orders.returns.reason")}),e.jsx(f.Hint,{className:"!mt-1",children:v("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(f.Field,{control:d.control,name:`inbound_items.${m}.reason_id`,render:({field:{ref:k,value:C,onChange:g,...N}})=>e.jsxs(f.Item,{children:[e.jsx(f.Control,{children:e.jsx(de,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:C,onChange:H=>{p({reason_id:H}),g(H)},...N,options:I.map(H=>({label:H.label,value:H.id}))})}),e.jsx(f.ErrorMessage,{})]})})}),e.jsx(le,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{d.setValue(`inbound_items.${m}.reason_id`,null),p({reason_id:null})},children:e.jsx(Ae,{className:"text-ui-fg-muted"})})]})]}),q&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(f.Label,{children:v("orders.returns.note")}),e.jsx(f.Hint,{className:"!mt-1",children:v("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(f.Field,{control:d.control,name:`inbound_items.${m}.note`,render:({field:{ref:k,...C}})=>e.jsxs(f.Item,{children:[e.jsx(f.Control,{children:e.jsx(Ie,{...C,onBlur:()=>{C.onChange(C.value),p({internal_note:C.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(f.ErrorMessage,{})]})})}),e.jsx(le,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{d.setValue(`inbound_items.${m}.note`,null),p({internal_note:null})},children:e.jsx(Ae,{className:"text-ui-fg-muted"})})]})]})]})]})}var fn=he({inbound_items:qe(he({item_id:X(),quantity:ke(),reason_id:X().nullish(),note:X().nullish()})),outbound_items:qe(he({item_id:X(),quantity:ke()})),location_id:X().optional(),inbound_option_id:X().nullish(),outbound_option_id:X().nullish(),send_notification:$t().optional()}),re=it(),pn=i=>{const{t:l}=F();return y.useMemo(()=>[re.display({id:"select",header:({table:r})=>e.jsx(ce,{checked:r.getIsSomePageRowsSelected()?"indeterminate":r.getIsAllPageRowsSelected(),onCheckedChange:d=>r.toggleAllPageRowsSelected(!!d)}),cell:({row:r})=>{const d=r.getCanSelect();return e.jsx(ce,{disabled:!d,checked:r.getIsSelected(),onCheckedChange:s=>r.toggleSelected(!!s),onClick:s=>{s.stopPropagation()}})}}),re.display({id:"product",header:()=>e.jsx(Ge,{}),cell:({row:r})=>e.jsx($e,{product:r.original.product})}),re.accessor("sku",{header:l("fields.sku"),cell:({getValue:r})=>r()||"-"}),re.accessor("title",{header:l("fields.title")})],[l,i])},hn=()=>{const{t:i}=F();return[{key:"created_at",label:i("fields.createdAt"),type:"date"},{key:"updated_at",label:i("fields.updatedAt"),type:"date"}]},xn=({pageSize:i=50,prefix:l})=>{const r=Ye(["q","offset","order","created_at","updated_at"],l),{offset:d,created_at:s,updated_at:p,...m}=r;return{searchParams:{...m,limit:i,offset:d?Number(d):0,created_at:s?JSON.parse(s):void 0,updated_at:p?JSON.parse(p):void 0},raw:r}},ge=50,Fe="rit",gn=({onSelectionChange:i,selectedItems:l,currencyCode:r})=>{const{t:d}=F(),[s,p]=y.useState(l.reduce((g,N)=>(g[N]=!0,g),{})),m=g=>{const N=typeof g=="function"?g(s):g;p(N),i(Object.keys(N))},{searchParams:v,raw:I}=xn({pageSize:ge,prefix:Fe}),{variants:_=[],count:E}=nn({...v,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),q=pn(r),k=hn(),{table:C}=Ke({data:_,columns:q,count:E,enablePagination:!0,getRowId:g=>g.id,pageSize:ge,enableRowSelection:g=>!0,rowSelection:{state:s,updater:m}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ze,{table:C,columns:q,pageSize:ge,count:E,filters:k,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:d("fields.product")},{key:"title",label:d("fields.title")},{key:"sku",label:d("fields.sku")}],prefix:Fe,queryObject:I})})};function bn({previewItem:i,currencyCode:l,form:r,onRemove:d,onUpdate:s,index:p}){const{t:m}=F();return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 border-b p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Xe,{src:i.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(z,{className:"txt-small",as:"span",weight:"plus",children:[i.title," "]}),i.variant_sku&&e.jsxs("span",{children:["(",i.variant_sku,")"]})]}),e.jsx(z,{as:"div",className:"text-ui-fg-subtle txt-small",children:i.subtitle})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(f.Field,{control:r.control,name:`outbound_items.${p}.quantity`,render:({field:v})=>e.jsxs(f.Item,{children:[e.jsx(f.Control,{children:e.jsx(Ie,{...v,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:I=>{const _=I.target.value,E=_===""?null:Number(_);v.onChange(E),E&&s({quantity:E})}})}),e.jsx(f.ErrorMessage,{})]})}),e.jsx(z,{className:"txt-small text-ui-fg-subtle",children:m("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(Ve,{currencyCode:l,amount:i.total})}),e.jsx(Je,{groups:[{actions:[{label:m("actions.remove"),onClick:d,icon:e.jsx(nt,{})}].filter(Boolean)}]})]})]})})}var be=[],Le=[],_n=({order:i,preview:l,claim:r,form:d})=>{const{t:s}=F(),{setIsOpen:p}=et(),[m,v]=y.useState({}),{shipping_options:I=[]}=tt({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id"}),_=I.filter(x=>!!x.rules.find(h=>h.attribute==="is_return"&&h.value==="false")),{mutateAsync:E}=Ot(r.id,i.id),{mutateAsync:q}=Ht(r.id,i.id),{mutateAsync:k}=Ft(r.id,i.id),{mutateAsync:C}=Lt(r.id,i.id),{mutateAsync:g}=Bt(r.id,i.id),N=y.useMemo(()=>{var x;return(x=l==null?void 0:l.items)==null?void 0:x.filter(h=>{var u;return!!((u=h.actions)!=null&&u.find(b=>b.claim_id===r.id&&b.action==="ITEM_ADD"))})},[l.items]),H=y.useMemo(()=>{var x;return new Map((x=i==null?void 0:i.items)==null?void 0:x.map(h=>[h.variant_id,h]))},[i.items]),{fields:w,append:W,remove:K,update:Z}=Qe({name:"outbound_items",control:d.control}),$=y.useMemo(()=>new Map(N.map(x=>[x.variant_id,x])),[N,w]);y.useEffect(()=>{const x={};N.forEach(h=>{const u=w.findIndex(b=>b.item_id===h.id);x[h.id]=!0,u>-1?w[u].quantity!==h.detail.quantity&&Z(u,{...w[u],quantity:h.detail.quantity}):W({item_id:h.id,quantity:h.detail.quantity,variant_id:h.variant_id},{shouldFocus:!1})}),w.forEach((h,u)=>{h.item_id in x||K(u)})},[N]);const A=d.watch("location_id"),L=!w.length,V=async()=>{var x,h;be.length&&await k({items:be.map(u=>({variant_id:u,quantity:1}))},{onError:u=>{T.error(u.message)}});for(const u of Le){const b=(h=(x=N.find(S=>S.variant_id===u))==null?void 0:x.actions)==null?void 0:h.find(S=>S.action==="ITEM_ADD");b!=null&&b.id&&await g(b==null?void 0:b.id,{onError:S=>{T.error(S.message)}})}p("outbound-items",!1)},ue=async x=>{const u=l.shipping_methods.filter(b=>{var D;const S=(D=b.actions)==null?void 0:D.find(M=>M.action==="SHIPPING_ADD"&&!M.return_id);return S&&!(S!=null&&S.return_id)}).filter(Boolean).map(b=>{var D;const S=(D=b.actions)==null?void 0:D.find(M=>M.action==="SHIPPING_ADD"&&!M.return_id);if(S)return q(S.id)});await Promise.all(u),x&&await E({shipping_option_id:x},{onError:b=>{T.error(b.message)}})},me=y.useMemo(()=>A?!w.map(h=>{var b,S;const u=H.get(h.variant_id);return!(u!=null&&u.variant_id)||!(u!=null&&u.variant)||!((b=u.variant)!=null&&b.manage_inventory)?!0:(S=m[u.variant_id])==null?void 0:S.find(D=>D.location_id===A)}).every(Boolean):!1,[w,m,A]);return y.useEffect(()=>{(async()=>{const h={};if(!w.length)return h;const u=w.map(S=>S==null?void 0:S.variant_id).filter(Boolean);return(await We.admin.productVariant.list({id:u,fields:"*inventory.location_levels"})).variants.forEach(S=>{var D,M;h[S.id]=((M=(D=S.inventory)==null?void 0:D[0])==null?void 0:M.location_levels)||[]}),h})().then(h=>{v(h)})},[w]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ve,{level:"h2",children:s("orders.returns.outbound")}),e.jsxs(B,{id:"outbound-items",children:[e.jsx(B.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:s("actions.addItems")})}),e.jsxs(B.Content,{children:[e.jsx(B.Header,{}),e.jsx(gn,{selectedItems:w.map(x=>x.variant_id),currencyCode:i.currency_code,onSelectionChange:x=>{const h=w.map(u=>u.variant_id);be=x.filter(u=>!h.includes(u)),Le=h.filter(u=>!x.includes(u))}}),e.jsx(B.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(G.Close,{asChild:!0,children:e.jsx(te,{type:"button",variant:"secondary",size:"small",children:s("actions.cancel")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await V(),children:s("actions.save")},"submit-button")]})})})]})]})]}),L&&e.jsx(ze,{}),w.map((x,h)=>$.get(x.variant_id)&&e.jsx(bn,{previewItem:$.get(x.variant_id),currencyCode:i.currency_code,form:d,onRemove:()=>{var b,S,D;const u=(D=(S=(b=N.find(M=>M.id===x.item_id))==null?void 0:b.actions)==null?void 0:S.find(M=>M.action==="ITEM_ADD"))==null?void 0:D.id;u&&g(u,{onError:M=>{T.error(M.message)}})},onUpdate:u=>{var S,D,M;const b=(M=(D=(S=N.find(Q=>Q.id===x.item_id))==null?void 0:S.actions)==null?void 0:D.find(Q=>Q.action==="ITEM_ADD"))==null?void 0:M.id;b&&C({...u,actionId:b},{onError:Q=>{T.error(Q.message)}})},index:h},x.id)),!L&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(f.Label,{children:s("orders.claims.outboundShipping")}),e.jsx(f.Hint,{className:"!mt-1",children:s("orders.claims.outboundShippingHint")})]}),e.jsx(f.Field,{control:d.control,name:"outbound_option_id",render:({field:{value:x,onChange:h,...u}})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(de,{allowClear:!0,value:x??void 0,onChange:b=>{h(b),ue(b)},...u,options:_.map(b=>({label:b.name,value:b.id})),disabled:!_.length,noResultsPlaceholder:e.jsx(Nt,{})})})})})]})}),me&&e.jsxs(st,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:s("orders.returns.noInventoryLevel")}),e.jsx(z,{className:"text-ui-fg-subtle txt-small leading-normal",children:s("orders.returns.noInventoryLevelDesc")})]})]})},_e=[],Be=[],je=!1,jn=({order:i,preview:l,claim:r,orderReturn:d})=>{var Pe;const{t:s}=F(),{handleSuccess:p}=an(),{setIsOpen:m}=et(),[v,I]=y.useState(!1),[_,E]=y.useState(!1),[q,k]=y.useState({value:"0",float:0}),[C,g]=y.useState({value:"0",float:0}),[N,H]=y.useState({}),{mutateAsync:w,isPending:W}=Et(r.id,i.id),{mutateAsync:K,isPending:Z}=wt(r.id,i.id),{mutateAsync:$,isPending:A}=Ut((Pe=l==null?void 0:l.order_change)==null?void 0:Pe.return_id,i.id),{mutateAsync:L,isPending:V}=qt(r.id,i.id),{mutateAsync:ue,isPending:me}=kt(r.id,i.id),{mutateAsync:x,isPending:h}=At(r.id,i.id),{mutateAsync:u,isPending:b}=Mt(r.id,i.id),{mutateAsync:S,isPending:D}=Dt(r.id,i.id),{mutateAsync:M,isPending:Q}=Tt(r.id,i.id),{mutateAsync:Se,isPending:at}=Rt(r.id,i.id),ot=W||Z||V||me||b||h||D||at||Q||A,U=y.useMemo(()=>{var n;return(n=l==null?void 0:l.items)==null?void 0:n.filter(o=>{var t;return!!((t=o.actions)!=null&&t.find(a=>a.claim_id===r.id))})},[l.items]),ne=U.filter(n=>{var o;return!!((o=n.actions)!=null&&o.find(t=>t.action==="RETURN_ITEM"))}),fe=U.filter(n=>{var o;return!!((o=n.actions)!=null&&o.find(t=>t.action==="ITEM_ADD"))}),pe=y.useMemo(()=>{var n;return new Map((n=i==null?void 0:i.items)==null?void 0:n.map(o=>[o.id,o]))},[i.items]),R=Kt({defaultValues:()=>{const n=l.shipping_methods.find(t=>{var a;return!!((a=t.actions)!=null&&a.find(c=>c.action==="SHIPPING_ADD"&&!!c.return_id))}),o=l.shipping_methods.find(t=>{var a;return!!((a=t.actions)!=null&&a.find(c=>c.action==="SHIPPING_ADD"&&!c.return_id))});return Promise.resolve({inbound_items:ne.map(t=>{var c,j;const a=(c=t.actions)==null?void 0:c.find(P=>P.action==="RETURN_ITEM");return{item_id:t.id,variant_id:t.variant_id,quantity:t.detail.return_requested_quantity,note:a==null?void 0:a.internal_note,reason_id:(j=a==null?void 0:a.details)==null?void 0:j.reason_id}}),outbound_items:fe.map(t=>({item_id:t.id,variant_id:t.variant_id,quantity:t.detail.quantity})),inbound_option_id:n?n.shipping_option_id:"",outbound_option_id:o?o.shipping_option_id:"",location_id:d==null?void 0:d.location_id,send_notification:!1})},resolver:Zt(fn)}),Y=R.watch("location_id"),{stock_locations:rt=[]}=Yt({limit:999}),{shipping_options:lt=[]}=tt({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:Y},{enabled:!!Y}),dt=lt.filter(n=>!!n.rules.find(o=>o.attribute==="is_return"&&o.value==="true")),se=l.shipping_methods.find(n=>{var o;return!!((o=n.actions)!=null&&o.find(t=>t.action==="SHIPPING_ADD"&&!!t.return_id))}),ie=l.shipping_methods.find(n=>{var o;return!!((o=n.actions)!=null&&o.find(t=>t.action==="SHIPPING_ADD"&&!t.return_id))});y.useEffect(()=>{se&&k({value:se.total.toFixed(oe[i.currency_code.toUpperCase()].decimal_digits),float:se.total})},[se]),y.useEffect(()=>{ie&&g({value:ie.total.toFixed(oe[i.currency_code.toUpperCase()].decimal_digits),float:ie.total})},[ie]);const{fields:O,append:ct,remove:ut,update:mt}=Qe({name:"inbound_items",control:R.control}),Ne=y.useMemo(()=>new Map(U.map(n=>[n.id,n])),[U,O]);y.useEffect(()=>{const n={};ne.forEach(o=>{var a,c;const t=O.findIndex(j=>j.item_id===o.id);if(n[o.id]=!0,t>-1){if(O[t].quantity!==o.detail.return_requested_quantity){const j=(a=o.actions)==null?void 0:a.find(P=>P.action==="RETURN_ITEM");mt(t,{...O[t],quantity:o.detail.return_requested_quantity,note:j==null?void 0:j.internal_note,reason_id:(c=j==null?void 0:j.details)==null?void 0:c.reason_id})}}else ct({item_id:o.id,quantity:o.detail.return_requested_quantity},{shouldFocus:!1})}),O.forEach((o,t)=>{o.item_id in n||ut(t)})},[U]),y.useEffect(()=>{const n=l.shipping_methods.find(t=>{var a;return!!((a=t.actions)!=null&&a.find(c=>c.action==="SHIPPING_ADD"&&!!c.return_id))});n?R.setValue("inbound_option_id",n.shipping_option_id):R.setValue("inbound_option_id",null);const o=l.shipping_methods.find(t=>{var a;return!!((a=t.actions)!=null&&a.find(c=>c.action==="SHIPPING_ADD"&&!c.return_id))});o?R.setValue("outbound_option_id",o.shipping_option_id):R.setValue("outbound_option_id",null)},[l.shipping_methods]),y.useEffect(()=>{R.setValue("location_id",d==null?void 0:d.location_id)},[d]);const ae=!ne.length,Ce=!fe.length,ft=R.watch("inbound_option_id"),pt=R.watch("outbound_option_id"),ht=on(),xt=R.handleSubmit(async n=>{await ht({title:s("general.areYouSure"),description:s("orders.claims.confirmText"),confirmText:s("actions.continue"),cancelText:s("actions.cancel"),variant:"confirmation"})&&await w({no_notification:!n.send_notification},{onSuccess:()=>{T.success(s("orders.claims.toast.confirmedSuccessfully")),p()},onError:t=>{T.error(t.message)}})}),gt=async()=>{var n,o,t;_e.length&&await S({items:_e.map(a=>({id:a,quantity:1}))},{onError:a=>{T.error(a.message)}});for(const a of Be){const c=(t=(o=(n=U.find(j=>j.id===a))==null?void 0:n.actions)==null?void 0:o.find(j=>j.action==="RETURN_ITEM"))==null?void 0:t.id;c&&await Se(c,{onError:j=>{T.error(j.message)}})}m("inbound-items",!1)},bt=async n=>{await $({location_id:n})},_t=async n=>{const t=l.shipping_methods.filter(a=>{var j;const c=(j=a.actions)==null?void 0:j.find(P=>P.action==="SHIPPING_ADD"&&!!P.return_id);return c&&!!(c!=null&&c.return_id)}).filter(Boolean).map(a=>{var j;const c=(j=a.actions)==null?void 0:j.find(P=>P.action==="SHIPPING_ADD"&&!!P.return_id);if(c)return u(c.id)});await Promise.all(t),n&&await L({shipping_option_id:n},{onError:a=>{T.error(a.message)}})};y.useEffect(()=>{var n;v&&((n=document.getElementById("js-shipping-inbound-input"))==null||n.focus())},[v]),y.useEffect(()=>{var n;_&&((n=document.getElementById("js-shipping-outbound-input"))==null||n.focus())},[_]);const jt=y.useMemo(()=>Y?!O.map(o=>{var a,c;const t=pe.get(o.item_id);return!(t!=null&&t.variant_id)||!(t!=null&&t.variant)||!((a=t.variant)!=null&&a.manage_inventory)?!0:(c=N[t.variant_id])==null?void 0:c.find(j=>j.location_id===Y)}).every(Boolean):!1,[O,N,Y]);y.useEffect(()=>{(async()=>{const o={};if(!O.length)return o;const t=O.map(c=>c==null?void 0:c.variant_id).filter(Boolean);return(await We.admin.productVariant.list({id:t,fields:"*inventory.location_levels"})).variants.forEach(c=>{var j,P;o[c.id]=((P=(j=c.inventory)==null?void 0:j[0])==null?void 0:P.location_levels)||[]}),o})().then(o=>{H(o)})},[O]),y.useEffect(()=>()=>{je&&(K(void 0,{onSuccess:()=>{T.success(s("orders.claims.actions.cancelClaim.successToast"))},onError:n=>{T.error(n.message)}}),je=!1)},[]);const yt=y.useMemo(()=>{const n=l.shipping_methods.find(o=>{var t;return!!((t=o.actions)!=null&&t.find(a=>a.action==="SHIPPING_ADD"&&!!a.return_id))});return(n==null?void 0:n.total)||0},[l.shipping_methods]),vt=y.useMemo(()=>{const n=l.shipping_methods.find(o=>{var t;return!!((t=o.actions)!=null&&t.find(a=>a.action==="SHIPPING_ADD"&&!a.return_id))});return(n==null?void 0:n.total)||0},[l.shipping_methods]);return e.jsx(G.Form,{form:R,children:e.jsxs(sn,{onSubmit:xt,className:"flex h-full flex-col",children:[e.jsx(G.Header,{}),e.jsx(G.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(ve,{level:"h1",children:s("orders.claims.create")}),e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ve,{level:"h2",children:s("orders.returns.inbound")}),e.jsxs(B,{id:"inbound-items",children:[e.jsx(B.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:s("actions.addItems")})}),e.jsxs(B.Content,{children:[e.jsx(B.Header,{}),e.jsx(cn,{items:i.items,selectedItems:O.map(n=>n.item_id),currencyCode:i.currency_code,onSelectionChange:n=>{const o=O.map(t=>t.item_id);_e=n.filter(t=>!o.includes(t)),Be=o.filter(t=>!n.includes(t))}}),e.jsx(B.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(G.Close,{asChild:!0,children:e.jsx(te,{type:"button",variant:"secondary",size:"small",children:s("actions.cancel")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await gt(),children:s("actions.save")},"submit-button")]})})})]})]})]}),ae&&e.jsx(ze,{}),O.map((n,o)=>Ne.get(n.item_id)&&pe.get(n.item_id)&&e.jsx(mn,{item:pe.get(n.item_id),previewItem:Ne.get(n.item_id),currencyCode:i.currency_code,form:R,onRemove:()=>{var a,c,j;const t=(j=(c=(a=U.find(P=>P.id===n.item_id))==null?void 0:a.actions)==null?void 0:c.find(P=>P.action==="RETURN_ITEM"))==null?void 0:j.id;t&&Se(t,{onError:P=>{T.error(P.message)}})},onUpdate:t=>{var c,j;const a=(j=(c=U.find(P=>P.id===n.item_id))==null?void 0:c.actions)==null?void 0:j.find(P=>P.action==="RETURN_ITEM");a&&M({...t,actionId:a.id},{onError:P=>{var Ee,we;(Ee=a.details)!=null&&Ee.quantity&&t.quantity&&R.setValue(`inbound_items.${o}.quantity`,(we=a.details)==null?void 0:we.quantity),T.error(P.message)}})},index:o},n.id)),!ae&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(f.Label,{children:s("orders.returns.location")}),e.jsx(f.Hint,{className:"!mt-1",children:s("orders.returns.locationHint")})]}),e.jsx(f.Field,{control:R.control,name:"location_id",render:({field:{value:n,onChange:o,...t}})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(de,{...t,value:n??void 0,onChange:a=>{o(a),bt(a)},options:(rt??[]).map(a=>({label:a.name,value:a.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(f.Label,{children:[s("orders.returns.inboundShipping"),e.jsxs(z,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",s("fields.optional"),")"]})]}),e.jsx(f.Hint,{className:"!mt-1",children:s("orders.returns.inboundShippingHint")})]}),e.jsx(f.Field,{control:R.control,name:"inbound_option_id",render:({field:{value:n,onChange:o,...t}})=>e.jsx(f.Item,{children:e.jsx(f.Control,{children:e.jsx(de,{allowClear:!0,value:n??void 0,onChange:a=>{o(a),_t(a)},...t,options:dt.map(a=>({label:a.name,value:a.id})),disabled:!Y,noResultsPlaceholder:e.jsx(It,{})})})})})]})]}),jt&&e.jsxs(st,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:s("orders.returns.noInventoryLevel")}),e.jsx(z,{className:"text-ui-fg-subtle txt-small leading-normal",children:s("orders.returns.noInventoryLevelDesc")})]}),e.jsx(_n,{form:R,preview:l,order:i,claim:r}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:s("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:J(ne.reduce((n,o)=>{var a;const t=(a=o.actions)==null?void 0:a.find(c=>c.action==="RETURN_ITEM");return n=n+((t==null?void 0:t.amount)||0),n},0)*-1,i.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:s("orders.claims.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:J(fe.reduce((n,o)=>{var a;const t=(a=o.actions)==null?void 0:a.find(c=>c.action==="ITEM_ADD");return n=n+((t==null?void 0:t.amount)||0),n},0),i.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:s("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!v&&e.jsx(le,{onClick:()=>I(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:ae||!ft,children:e.jsx(Me,{})}),v?e.jsx(De,{id:"js-shipping-inbound-input",onBlur:()=>{let n;l.shipping_methods.forEach(t=>{if(t.actions)for(const a of t.actions)a.action==="SHIPPING_ADD"&&a.return_id&&(n=a.id)});const o=q.float;n&&ue({actionId:n,custom_amount:o},{onError:t=>{T.error(t.message)}}),I(!1)},symbol:oe[i.currency_code.toUpperCase()].symbol_native,code:i.currency_code,onValueChange:(n,o,t)=>{k({value:(t==null?void 0:t.value)||"",float:(t==null?void 0:t.float)||null})},value:q.value,disabled:ae}):J(yt,i.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:s("orders.claims.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!_&&e.jsx(le,{onClick:()=>E(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:Ce||!pt,children:e.jsx(Me,{})}),_?e.jsx(De,{id:"js-shipping-outbound-input",onBlur:()=>{let n;l.shipping_methods.forEach(t=>{if(t.actions)for(const a of t.actions)a.action==="SHIPPING_ADD"&&!a.return_id&&(n=a.id)});const o=C.float;n&&x({actionId:n,custom_amount:o},{onError:t=>{T.error(t.message)}}),E(!1)},symbol:oe[i.currency_code.toUpperCase()].symbol_native,code:i.currency_code,onValueChange:(n,o,t)=>{g({value:(t==null?void 0:t.value)||"",float:(t==null?void 0:t.float)||null})},value:C.value,disabled:Ce}):J(vt,i.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:s("orders.claims.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:J(l.summary.pending_difference,i.currency_code)})]})]}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(f.Field,{control:R.control,name:"send_notification",render:({field:{onChange:n,value:o,...t}})=>e.jsxs(f.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(f.Control,{className:"mr-4 self-start",children:e.jsx(en,{className:"mt-[2px]",checked:!!o,onCheckedChange:n,...t})}),e.jsxs("div",{className:"block",children:[e.jsx(f.Label,{children:s("orders.returns.sendNotification")}),e.jsx(f.Hint,{className:"!mt-1",children:s("orders.returns.sendNotificationHint")})]})]}),e.jsx(f.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(G.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(G.Close,{asChild:!0,children:e.jsx(te,{type:"button",onClick:()=>je=!0,variant:"secondary",size:"small",children:s("orders.claims.cancel.title")})}),e.jsx(te,{type:"submit",variant:"primary",size:"small",isLoading:ot,children:s("orders.claims.confirm")},"submit-button")]})})})]})})},ye=!1,fs=()=>{const{id:i}=Qt(),l=Xt(),{t:r}=F(),{order:d}=Jt(i,{fields:Gt}),{order:s}=Wt(i),[p,m]=y.useState(),{mutateAsync:v}=Ct(d.id),{claim:I}=Pt(p,void 0,{enabled:!!p}),{return:_}=Vt(I==null?void 0:I.return_id,void 0,{enabled:!!(I!=null&&I.return_id)});return y.useEffect(()=>{async function E(){if(!(ye||!s)){if(s.order_change){s.order_change.change_type==="claim"?m(s.order_change.claim_id):(l(`/orders/${s.id}`,{replace:!0}),T.error(r("orders.claims.activeChangeError")));return}ye=!0;try{const{claim:q}=await v({order_id:s.id,type:"replace"});m(q.id)}catch(q){T.error(q.message),l(`/orders/${s.id}`,{replace:!0})}finally{ye=!1}}}E()},[s]),e.jsx(G,{children:I&&s&&d&&e.jsx(jn,{order:d,claim:I,preview:s,orderReturn:_})})};export{fs as Component};
