import{c as J,d as X,e as F,f as Y,g as Z,h as ee,i as te,j as se,k as re,l as ae}from"./chunk-GUHHFSZA-CZzasLq6.js";import{a as V}from"./chunk-PDWBYQOW-BedvhUOI.js";import{K as ne}from"./chunk-6HTZNHPT-46xTxqsX.js";import{b as w,u as ie}from"./chunk-4TC5YS65-D1UjD2uU.js";import{r as u,a2 as P,ad as oe,af as $,a4 as le,a5 as ce,R as de,b as M,u as ue,aS as me,aV as fe,t as y,j as e,H as he,a_ as xe,a8 as pe,a9 as ye,T as O,aC as ge,w as x,x as U,ab as ve,B as A}from"./index-BuxV6e0B.js";import{A as _e}from"./alert-CvAq8Jjb.js";import{P as D}from"./popover-12uuNIe1.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./prompt-BbGWPD2t.js";import"./x-mark-mini-DsfxIEYF.js";import"./index-D9jlmLrk.js";var je=Object.defineProperty,q=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable,S=(t,r,s)=>r in t?je(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,be=(t,r)=>{for(var s in r)B.call(r,s)&&S(t,s,r[s]);if(q)for(var s of q(r))H.call(r,s)&&S(t,s,r[s]);return t},Ne=(t,r)=>{var s={};for(var a in t)B.call(t,a)&&r.indexOf(a)<0&&(s[a]=t[a]);if(t!=null&&q)for(var a of q(t))r.indexOf(a)<0&&H.call(t,a)&&(s[a]=t[a]);return s};const z=u.forwardRef((t,r)=>{var s=t,{color:a="currentColor"}=s,m=Ne(s,["color"]);return u.createElement("svg",be({xmlns:"http://www.w3.org/2000/svg",width:15,height:15,fill:"none",ref:r},m),u.createElement("path",{stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M13.056 7.5H1.944M9.278 3.722 13.056 7.5l-3.778 3.778"}))});z.displayName="ArrowRight";var Ee=Object.defineProperty,T=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,L=(t,r,s)=>r in t?Ee(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,we=(t,r)=>{for(var s in r)Q.call(r,s)&&L(t,s,r[s]);if(T)for(var s of T(r))G.call(r,s)&&L(t,s,r[s]);return t},Re=(t,r)=>{var s={};for(var a in t)Q.call(t,a)&&r.indexOf(a)<0&&(s[a]=t[a]);if(t!=null&&T)for(var a of T(t))r.indexOf(a)<0&&G.call(t,a)&&(s[a]=t[a]);return s};const W=u.forwardRef((t,r)=>{var s=t,{color:a="currentColor"}=s,m=Re(s,["color"]);return u.createElement("svg",we({xmlns:"http://www.w3.org/2000/svg",width:15,height:15,fill:"none",ref:r},m),u.createElement("path",{stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7.5 3.473 5.722 5.722 9.278 7.5 7.5 9.278"}),u.createElement("path",{stroke:a,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7.081 13.03a.9.9 0 0 0 .837 0c1.395-.727 5.803-3.366 5.803-7.655a3.42 3.42 0 0 0-3.4-3.43A3.45 3.45 0 0 0 7.5 3.472a3.45 3.45 0 0 0-2.82-1.529 3.42 3.42 0 0 0-3.401 3.43c0 4.29 4.407 6.929 5.802 7.657"}))});W.displayName="HeartBroken";var Ie=P({items:oe(P({quantity:$().nullish(),dismissed_quantity:$().nullish(),item_id:le()})),send_notification:ce().optional()});function Ce({form:t,item:r,index:s,returnId:a,orderId:m}){const{t:o}=M(),[b,R]=u.useState(!1),{mutateAsync:I}=se(a,m),{mutateAsync:C}=re(a,m),{mutateAsync:j}=ae(a,m),[N,E]=u.useMemo(()=>{var g,n;const l=(g=r.actions)==null?void 0:g.find(i=>i.action==="RECEIVE_RETURN_ITEM"),d=(n=r.actions)==null?void 0:n.find(i=>i.action==="RECEIVE_DAMAGED_RETURN_ITEM");return[l==null?void 0:l.details.quantity,d==null?void 0:d.details.quantity]},[r]),p=async l=>{var g;const d=(g=r.actions)==null?void 0:g.find(n=>n.action==="RECEIVE_DAMAGED_RETURN_ITEM");if(typeof l=="number"&&l<0){t.setValue(`items.${s}.dismissed_quantity`,E,{shouldTouch:!0,shouldDirty:!0}),y.error(o("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof l=="number"&&l>r.quantity-r.detail.return_received_quantity){t.setValue(`items.${s}.dismissed_quantity`,E,{shouldTouch:!0,shouldDirty:!0}),y.error(o("orders.returns.receive.toast.errorLargeDamagedValue"));return}try{l?d?await C({actionId:d.id,quantity:l}):await I({items:[{id:r.id,quantity:l}]}):d&&await j(d.id)}catch(n){y.error(n.message)}};return e.jsxs(D,{open:b,onOpenChange:R,children:[e.jsx(D.Trigger,{asChild:!0,children:e.jsxs(A,{className:"flex gap-2 px-2",variant:"secondary",type:"button",children:[e.jsx("div",{children:e.jsx(W,{})}),!!E&&e.jsx("span",{children:E})]})}),e.jsx(D.Content,{align:"center",children:e.jsxs("div",{className:"flex flex-col p-2",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle mb-2 font-medium",children:o("orders.returns.receive.writeOffInputLabel")}),e.jsx(x.Field,{control:t.control,name:`items.${s}.dismissed_quantity`,render:({field:{onChange:l,value:d,...g}})=>e.jsx(x.Item,{className:"w-full",children:e.jsx(x.Control,{children:e.jsx(U,{min:0,max:r.quantity,type:"number",value:d,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:n=>{const i=n.target.value===""?null:parseFloat(n.target.value);l(i)},...g,onBlur:()=>{g.onBlur(),p(d)}})})})})]})})]})}var qe=Ce;function Te({order:t,preview:r,orderReturn:s}){const{t:a}=M(),{handleSuccess:m}=ie(),o=u.useMemo(()=>{const n={};return s.items.forEach(i=>n[i.item_id]=!0),r.items.filter(i=>n[i.id])},[r.items,s]),{mutateAsync:b}=Y(s.id,t.id),{mutateAsync:R}=Z(s.id,t.id),{mutateAsync:I}=F(s.id,t.id),{mutateAsync:C}=ee(s.id,t.id),{mutateAsync:j}=te(s.id,t.id),{stock_location:N}=xe(s.location_id,void 0,{enabled:!!s.location_id}),E=u.useMemo(()=>{const n={};return t.items.forEach(i=>n[i.id]=i),n},[t.items]),p=pe({defaultValues:{items:o==null?void 0:o.sort((n,i)=>n.id.localeCompare(i.id)).map(n=>({item_id:n.id})),send_notification:!1},resolver:ye(Ie)});u.useEffect(()=>{o==null||o.sort((n,i)=>n.id.localeCompare(i.id)).forEach((n,i)=>{var v,_;const f=(v=n.actions)==null?void 0:v.find(h=>h.action==="RECEIVE_RETURN_ITEM"),c=(_=n.actions)==null?void 0:_.find(h=>h.action==="RECEIVE_DAMAGED_RETURN_ITEM");p.setValue(`items.${i}.quantity`,f==null?void 0:f.details.quantity,{shouldTouch:!0,shouldDirty:!0}),p.setValue(`items.${i}.dismissed_quantity`,c==null?void 0:c.details.quantity,{shouldTouch:!0,shouldDirty:!0})})},[o]);const l=p.handleSubmit(async n=>{try{await b({no_notification:!n.send_notification}),m(`/orders/${t.id}`),y.success(a("general.success"),{description:a("orders.returns.receive.toast.success"),dismissLabel:a("actions.close")})}catch(i){y.error(a("general.error"),{description:i.message,dismissLabel:a("actions.close")})}}),d=async(n,i,f)=>{var _;const c=o==null?void 0:o.find(h=>h.id===n),v=(_=c==null?void 0:c.actions)==null?void 0:_.find(h=>h.action==="RECEIVE_RETURN_ITEM");if(typeof i=="number"&&i<0){p.setValue(`items.${f}.quantity`,c.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),y.error(a("orders.returns.receive.toast.errorNegativeValue"));return}if(typeof i=="number"&&i>c.quantity){p.setValue(`items.${f}.quantity`,c.detail.return_received_quantity,{shouldTouch:!0,shouldDirty:!0}),y.error(a("orders.returns.receive.toast.errorLargeValue"));return}try{if(v){if(i===null||i===0){await j(v.id);return}await C({actionId:v.id,quantity:i})}else typeof i=="number"&&i>0&&i<=c.quantity&&await I({items:[{id:c.id,quantity:i}]})}catch(h){y.error(h.message)}},g=async n=>{try{n||await R()}catch(i){y.error(i.message)}};return e.jsx(w.Form,{form:p,onClose:g,children:e.jsxs(ne,{onSubmit:l,className:"flex size-full flex-col overflow-hidden",children:[e.jsxs(w.Body,{className:"flex size-full flex-col overflow-auto",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{children:N&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"text-ui-fg-subtle"})," ",e.jsx("span",{className:"text-ui-fg-base txt-small font-medium",children:N.name})]})}),e.jsx("span",{className:"text-ui-fg-muted txt-small text-right",children:a("orders.returns.receive.itemsLabel")})]}),o.map((n,i)=>{const f=E[n.id];return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest mt-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsxs(O,{size:"small",className:"text-ui-fg-subtle",children:[n.quantity,"x"]}),e.jsx(ge,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),f.variant_sku&&e.jsxs("span",{children:["(",f.variant_sku,")"]})]}),e.jsx(O,{as:"div",className:"text-ui-fg-subtle txt-small",children:f.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-2",children:[e.jsx(qe,{form:p,item:n,index:i,returnId:s.id,orderId:t.id}),e.jsx(x.Field,{control:p.control,name:`items.${i}.quantity`,render:({field:{onChange:c,value:v,..._}})=>e.jsx(x.Item,{className:"w-full",children:e.jsx(x.Control,{children:e.jsx(U,{min:0,max:n.quantity,type:"number",value:v,className:"bg-ui-bg-field-component text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",onChange:h=>{const K=h.target.value===""?null:parseFloat(h.target.value);c(K)},..._,onBlur:()=>{_.onBlur(),d(n.id,v,i)}})})})})]})]})},n.id)}),e.jsxs("div",{className:"my-6 border-b border-t border-dashed py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("fields.total")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:V(r.total,t.currency_code)})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:a("orders.returns.outstandingAmount")}),e.jsx("span",{className:"txt-small font-medium",children:V(r.summary.pending_difference||0,t.currency_code)})]})]}),e.jsx(_e,{className:"rounded-xl",variant:"warning",children:a("orders.returns.receive.inventoryWarning")}),e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl p-3",children:e.jsx(x.Field,{control:p.control,name:"send_notification",render:({field:{onChange:n,value:i,...f}})=>e.jsxs(x.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x.Control,{children:e.jsx(ve,{className:"mt-1 self-start",checked:!!i,onCheckedChange:n,...f})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(x.Label,{children:a("orders.returns.sendNotification")}),e.jsx(x.Hint,{className:"!mt-1",children:a("orders.returns.receive.sendNotificationHint")})]})]}),e.jsx(x.ErrorMessage,{})]})})})]}),e.jsx(w.Footer,{className:"overflow-hidden",children:e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(A,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(A,{size:"small",type:"submit",isLoading:!1,children:a("actions.save")})]})})]})})}var k=!1;function Ue(){const{id:t,return_id:r}=de(),{t:s}=M(),a=ue(),{order:m}=me(t,{fields:"+currency_code,*items"}),{order:o}=fe(t),{return:b}=J(r,{fields:"*items.item,*items.item.variant,*items.item.variant.product"}),{mutateAsync:R}=X(r,t),{mutateAsync:I}=F(r,t);u.useEffect(()=>{(async function(){if(!(k||!o)){if(o.order_change){o.order_change.change_type!=="return_receive"&&(a(`/orders/${t}`,{replace:!0}),y.error(s("orders.returns.activeChangeError")));return}k=!0;try{const{return:j}=await R({});await I({items:j.items.map(N=>({id:N.item_id,quantity:N.quantity}))})}catch(j){y.error(j.message)}finally{k=!1}}})()},[o]);const C=m&&b&&o;return e.jsxs(w,{children:[e.jsx(w.Header,{children:e.jsx(he,{children:s("orders.returns.receive.title",{returnId:r==null?void 0:r.slice(-7)})})}),C&&e.jsx(Te,{order:m,orderReturn:b,preview:o})]})}export{Ue as Component};
