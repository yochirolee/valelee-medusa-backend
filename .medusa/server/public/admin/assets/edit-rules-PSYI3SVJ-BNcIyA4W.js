import{R as S}from"./chunk-GBFMXRDA-DknbDx4E.js";import{a2 as P,a4 as u,ad as v,ap as c,ae as A,af as B,a5 as w,R as C,b as _,da as D,j as s,H,d5 as U,db as z,dc as K,dd as L,r as M,a8 as N,a9 as T,B as F}from"./index-Cny3qPON.js";import"./chunk-2PMSBTXI-DdbDgagT.js";import{K as V}from"./chunk-6HTZNHPT-CuK6NmIV.js";import{b as m,u as $}from"./chunk-4TC5YS65-NVxWjOau.js";import"./chunk-HFB3OQXI-Bedclh8E.js";import"./x-mark-mini-C-KzuLRP.js";import"./select-8D0aV3E5.js";import"./triangles-mini-DHWqG8Fx.js";import"./check-DlpXJXNG.js";import"./plus-mini-CIFXT7aR.js";import"./prompt-KlOiT8I5.js";var k=P({type:u().optional(),rules:v(P({id:u().optional(),attribute:u().min(1,{message:c.t("promotions.form.required")}),operator:u().min(1,{message:c.t("promotions.form.required")}),values:A([B().min(1,{message:c.t("promotions.form.required")}),u().min(1,{message:c.t("promotions.form.required")}),v(u()).min(1,{message:c.t("promotions.form.required")})]),required:w().optional(),disguised:w().optional(),field_type:u().optional()}))}),I=({promotion:t,ruleType:f,handleSubmit:n,isSubmitting:r})=>{const{t:d}=_(),[o,a]=M.useState([]),l=N({defaultValues:{rules:[],type:t.type},resolver:T(k)}),p=l.handleSubmit(n(o));return s.jsx(m.Form,{form:l,children:s.jsxs(V,{onSubmit:p,className:"flex h-full flex-col",children:[s.jsx(m.Body,{children:s.jsx(S,{form:l,ruleType:f,setRulesToRemove:a,rulesToRemove:o,promotion:t})}),s.jsx(m.Footer,{children:s.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[s.jsx(m.Close,{asChild:!0,children:s.jsx(F,{size:"small",variant:"secondary",disabled:r,children:d("actions.cancel")})}),s.jsx(F,{size:"small",type:"submit",isLoading:r,children:d("actions.save")})]})})]})})},O=t=>t.field_type==="number"?parseInt(t.values):t.values,W=({promotion:t,rules:f,ruleType:n})=>{const{handleSuccess:r}=$(),{mutateAsync:d}=U(t.id),{mutateAsync:o}=z(t.id,n),{mutateAsync:a}=K(t.id,n),{mutateAsync:l,isPending:p}=L(t.id,n),y=i=>async function(h){const g={},{rules:b=[]}=h,E=b.filter(e=>e.disguised),q=(i==null?void 0:i.filter(e=>e.disguised))||[];for(const e of E)g[e.attribute]=O(e);for(const e of q)g[e.attribute]=null;const x=b.filter(e=>!e.disguised),j=x.filter(e=>!("id"in e)),R=x.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),j.length&&await o({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),i!=null&&i.length&&await a({rule_ids:i.map(e=>e.id).filter(Boolean)}),R.length&&await l({rules:R.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),r()};return s.jsx(I,{promotion:t,rules:f,ruleType:n,handleSubmit:y,isSubmitting:p})},oe=()=>{var i,h;const t=C();if(!["rules","buy-rules","target-rules"].includes(t.ruleType))throw"invalid page";const{t:n}=_(),r=t.ruleType,d=t.id,o=[],{promotion:a,isPending:l,isError:p,error:y}=D(d);if(a&&(r==="rules"?o.push(...a.rules||[]):r==="target-rules"?o.push(...((i=a==null?void 0:a.application_method)==null?void 0:i.target_rules)||[]):r==="buy-rules"&&o.push(...((h=a.application_method)==null?void 0:h.buy_rules)||[])),p)throw y;return s.jsxs(m,{children:[s.jsx(m.Header,{children:s.jsx(H,{children:n(`promotions.edit.${r}.title`)})}),!l&&a&&s.jsx(W,{promotion:a,rules:o,ruleType:r})]})};export{oe as Component};
