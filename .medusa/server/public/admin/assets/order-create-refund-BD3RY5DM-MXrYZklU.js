import{g as J}from"./chunk-AMRS4CSX-D69MbOMh.js";import{f as Q}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{f as B}from"./chunk-WATKBUHQ-CKylx9j4.js";import{g as O}from"./chunk-4XSXVVYD-C7XLEHYL.js";import{D as W}from"./chunk-D4T3GFML-k03o88f9.js";import{g as U}from"./chunk-PDWBYQOW-BedvhUOI.js";import{c as H}from"./chunk-MWVM4TYO-bKUcYSnf.js";import{K as k}from"./chunk-6HTZNHPT-AiCRXI8I.js";import{b as f,u as K}from"./chunk-4TC5YS65-WmRz150Y.js";import{a2 as y,a3 as X,a4 as S,af as v,cY as I,b as D,R as ee,aS as ne,aU as se,j as e,H as te,a0 as $,r as F,a8 as q,a9 as G,cZ as re,t as C,z as M,m as z,D as ae,w as r,B as R}from"./index-B1ljKk9e.js";import{a as Y}from"./chunk-F3G43K3W-DKo3uMTu.js";import{f as w}from"./index.esm-DJCiCQY0.js";import{R as E}from"./radio-group-BK_YqdKj.js";import{S as u}from"./select-eeeOwxhd.js";import{C as A}from"./currency-input-CXs11IuU.js";import{T as Z}from"./textarea-IDwc2g6Z.js";import"./prompt-CzfsqadD.js";import"./index-C0Ok2FE_.js";import"./triangles-mini-U9BoX_8v.js";import"./check-B__gGTN0.js";var oe=y({settlement_type:X(["credit_line","refund"]),refund:y({amount:y({value:S().or(v()).optional(),float:v().or(I())}),note:S().optional()}).optional(),credit_line:y({amount:y({value:S().or(v()).optional(),float:v().or(I())}),note:S().optional()}).optional()}),le=({order:c})=>{const{t:a}=D(),[x]=$(),{handleSuccess:_}=K(),h=x.get("paymentId"),T=O(c),b=c.summary.pending_difference*-1,[t,L]=F.useState(h&&T.find(n=>n.id===h)||null),l=q({defaultValues:{settlement_type:"refund",refund:{amount:{value:"",float:null}},credit_line:{amount:{value:"",float:null}}},resolver:G(oe)}),{mutateAsync:p,isPending:P}=re(c.id),{mutateAsync:N,isPending:V}=Y(c.id,t==null?void 0:t.id),s=l.watch("settlement_type"),m=l.handleSubmit(async n=>{var o,j;if(n.settlement_type==="credit_line"){if(((o=n.credit_line)==null?void 0:o.amount.float)===null)return;await p({amount:n.credit_line.amount.float*-1,reference:"refund",reference_id:c.id},{onSuccess:()=>{C.success(a("orders.creditLines.createCreditLineSuccess")),_()},onError:g=>{C.error(g.message)}})}if(n.settlement_type==="refund"){if(((j=n.refund)==null?void 0:j.amount.float)===null)return;await N({amount:n.refund.amount.float,note:n.refund.note},{onSuccess:()=>{C.success(a("orders.payment.refundPaymentSuccess",{amount:B(n.refund.amount.float,c.currency_code)})),_()},onError:g=>{C.error(g.message)}})}}),i=F.useMemo(()=>H[c.currency_code.toUpperCase()],[c.currency_code]);return F.useEffect(()=>{l.clearErrors();const n=t!=null&&t.amount?Math.min(b,t.amount):b,o={value:n.toFixed(i.decimal_digits),float:n};s==="refund"&&l.setValue("refund.amount",o),s==="credit_line"&&l.setValue("credit_line.amount",o)},[s,t,b,l,i]),e.jsx(f.Form,{form:l,children:e.jsxs(k,{onSubmit:m,className:"flex size-full flex-col overflow-hidden",children:[e.jsx(f.Body,{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsx(M,{className:"txt-compact-small font-sans font-medium",children:a("orders.balanceSettlement.settlementType")}),e.jsxs(E,{className:"flex flex-col gap-y-3",value:s,onValueChange:n=>l.setValue("settlement_type",n),children:[e.jsx(E.ChoiceBox,{value:"refund",description:a("orders.balanceSettlement.settlementTypes.paymentMethodDescription"),label:a("orders.balanceSettlement.settlementTypes.paymentMethod"),className:z("basis-1/2")}),e.jsx(E.ChoiceBox,{value:"credit_line",description:a("orders.balanceSettlement.settlementTypes.creditLineDescription"),label:a("orders.balanceSettlement.settlementTypes.creditLine"),className:z("basis-1/2")})]})]}),e.jsx(ae,{}),s==="refund"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(u,{defaultValue:t==null?void 0:t.id,onValueChange:n=>{L(T.find(o=>o.id===n))},children:[e.jsx(M,{className:"txt-compact-small mb-[-6px] font-sans font-medium",children:a("orders.payment.selectPaymentToRefund")}),e.jsx(u.Trigger,{children:e.jsx(u.Value,{placeholder:a("orders.payment.selectPaymentToRefund")})}),e.jsx(u.Content,{children:T.map(n=>{var j;const o=((j=n.refunds)==null?void 0:j.reduce((g,d)=>d.amount+g,0))??0;return e.jsxs(u.Item,{value:n.id,disabled:!!n.canceled_at||o>=n.amount,children:[e.jsxs("span",{children:[U(n.amount,n.currency_code)," - "]}),e.jsx("span",{children:n.provider_id}),e.jsxs("span",{children:[" - (",n.id.replace("pay_",""),")"]})]},n.id)})})]})}),e.jsx(r.Field,{control:l.control,name:"refund.amount",render:({field:{onChange:n,...o}})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:a("fields.amount")}),e.jsx(r.Control,{children:e.jsx(A,{...o,min:0,placeholder:w({value:"0",decimalScale:i.decimal_digits}),decimalScale:i.decimal_digits,symbol:i.symbol_native,code:i.code,value:o.value.value,onValueChange:(j,g,d)=>n({value:d==null?void 0:d.value,float:(d==null?void 0:d.float)||null}),autoFocus:!0})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:l.control,name:"refund.note",render:({field:n})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:a("fields.note")}),e.jsx(r.Control,{children:e.jsx(Z,{...n})}),e.jsx(r.ErrorMessage,{})]})})]}),s==="credit_line"&&e.jsx(e.Fragment,{children:e.jsx(r.Field,{control:l.control,name:"credit_line.amount",render:({field:{onChange:n,...o}})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:a("fields.amount")}),e.jsx(r.Control,{children:e.jsx(A,{...o,min:0,placeholder:w({value:"0",decimalScale:i.decimal_digits}),decimalScale:i.decimal_digits,symbol:i.symbol_native,code:i.code,value:o.value.value,onValueChange:(j,g,d)=>{n({value:d==null?void 0:d.value,float:(d==null?void 0:d.float)||null})},autoFocus:!0})}),e.jsx(r.ErrorMessage,{})]})})})]})}),e.jsx(f.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(f.Close,{asChild:!0,children:e.jsx(R,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(R,{isLoading:P||V,type:"submit",variant:"primary",size:"small",disabled:!!Object.keys(l.formState.errors||{}).length,children:a("actions.save")})]})})]})})},ie=y({amount:y({value:S().or(v()),float:v().or(I())}),note:S().optional()}),ce=({order:c})=>{const{t:a}=D(),{handleSuccess:x}=K(),[_]=$(),[h,T]=F.useState(_.get("paymentId")||void 0),b=O(c),t=b.find(s=>s.id===h),L=(t==null?void 0:t.amount)||0,l=F.useMemo(()=>H[c.currency_code.toUpperCase()],[c.currency_code]),p=q({defaultValues:{amount:{value:L.toFixed(l.decimal_digits),float:L},note:""},resolver:G(ie)});F.useEffect(()=>{const s=c.summary.pending_difference,m=(t==null?void 0:t.amount)||0,i=s<0?Math.min(Math.abs(s),m):m,n=i<0?i*-1:i;p.setValue("amount",{value:n.toFixed(l.decimal_digits),float:n})},[(t==null?void 0:t.id)||""]);const{mutateAsync:P,isPending:N}=Y(c.id,t==null?void 0:t.id),V=p.handleSubmit(async s=>{await P({amount:s.amount.float,note:s.note},{onSuccess:()=>{C.success(a("orders.payment.refundPaymentSuccess",{amount:B(s.amount.float,t==null?void 0:t.currency_code)})),x()},onError:m=>{C.error(m.message)}})});return e.jsx(f.Form,{form:p,children:e.jsxs(k,{onSubmit:V,className:"flex size-full flex-col overflow-hidden",children:[e.jsx(f.Body,{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs(u,{value:h,onValueChange:s=>{T(s)},children:[e.jsx(M,{className:"txt-compact-small mb-[-6px] font-sans font-medium",children:a("orders.payment.selectPaymentToRefund")}),e.jsx(u.Trigger,{children:e.jsx(u.Value,{placeholder:a("orders.payment.selectPaymentToRefund")})}),e.jsx(u.Content,{children:b.map(s=>{const m=s.refunds.reduce((i,n)=>n.amount+i,0);return e.jsxs(u.Item,{value:s.id,disabled:!!s.canceled_at||m>=s.amount,className:"flex items-center justify-center",children:[e.jsxs("span",{children:[U(s.amount,s.currency_code)," - "]}),e.jsx("span",{children:Q(s.provider_id)}),e.jsxs("span",{children:[" - (#",s.id.substring(23),")"]})]},s.id)})})]}),e.jsx(r.Field,{control:p.control,name:"amount",rules:{required:!0,min:0,max:L},render:({field:{onChange:s,...m}})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:a("fields.amount")}),e.jsx(r.Control,{children:e.jsx(A,{...m,min:0,placeholder:w({value:"0",decimalScale:l.decimal_digits}),decimalScale:l.decimal_digits,symbol:l.symbol_native,code:l.code,value:m.value.value,onValueChange:(i,n,o)=>s({value:o==null?void 0:o.value,float:(o==null?void 0:o.float)||null}),autoFocus:!0})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:p.control,name:"note",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:a("fields.note")}),e.jsx(r.Control,{children:e.jsx(Z,{...s})}),e.jsx(r.ErrorMessage,{})]})})]})}),e.jsx(f.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(f.Close,{asChild:!0,children:e.jsx(R,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(R,{isLoading:N,type:"submit",variant:"primary",size:"small",disabled:!!Object.keys(p.formState.errors||{}).length,children:a("actions.save")})]})})]})})},Ne=()=>{const{t:c}=D(),a=ee(),{order:x}=ne(a.id,{fields:W}),{plugins:_=[]}=se(),h=J(_);return e.jsxs(f,{children:[e.jsx(f.Header,{children:e.jsx(te,{children:c("orders.payment.createRefund")})}),x&&!h&&e.jsx(ce,{order:x}),x&&h&&e.jsx(le,{order:x})]})};export{Ne as Component};
